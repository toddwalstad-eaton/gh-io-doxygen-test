<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>BeagleBoneGPIODeviceHandler: /src/product-ref1/etn_source/bbb_gpio/source/bbb_gpio_core.cpp Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">BeagleBoneGPIODeviceHandler
   </div>
   <div id="projectbrief">GPIODeviceHandlerExample</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d6/d02/bbb__gpio__core_8cpp_source.html','../../');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">bbb_gpio_core.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d6/d02/bbb__gpio__core_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="preprocessor">#include &lt;sys/types.h&gt;</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="preprocessor">#include &lt;sys/stat.h&gt;</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="preprocessor">#include &lt;fcntl.h&gt;</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../de/ddb/bbb__gpio__core_8hpp.html">bbb_gpio_core.hpp</a>&quot;</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d1/d96/gpio__cds__handler_8hpp.html">gpio_cds_handler.hpp</a>&quot;</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d5/d37/bbb__tricolor__led_8hpp.html">bbb_tricolor_led.hpp</a>&quot;</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="preprocessor">#include &quot;px/cds/client.hpp&quot;</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="preprocessor">#include &quot;px/asio/io_manager.hpp&quot;</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="preprocessor">#include &quot;cds_defines.h&quot;</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div>
<div class="line"><a name="l00015"></a><span class="lineno"><a class="line" href="../../da/dad/classCBbbGpioCore.html#af999ee98dae951642f0e45cd7a31fef0">   15</a></span>&#160;<a class="code" href="../../da/dad/classCBbbGpioCore.html#af999ee98dae951642f0e45cd7a31fef0">CBbbGpioCore::CBbbGpioCore</a>( std::shared_ptr&lt;COptions&gt; options )</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;    : px::asio::CServerCore(),</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;    _parent_id( <a class="code" href="../../d8/da6/bbb__gpio_8hpp.html#aee1e362085b33fb6d9010e7ed4103939">DEFAULT_DEVICE_ID</a> ),</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;    _options( options ),</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;    chanid( <a class="code" href="../../d8/da6/bbb__gpio_8hpp.html#a51e7cf38f83d1d190fbc926396058131">DEFAULT_CH_ID</a> ),</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;    scale_factor( 0.0 ),</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;    update_interval_ms( <a class="code" href="../../d8/da6/bbb__gpio_8hpp.html#a36f5d02f9285599ac97ddf6ff741f53c">SLEEP_INTERVAL_MS</a> )</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;{</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;    PUSH_FUNC;</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;    <span class="comment">// Nothing further to do</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;}</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;</div>
<div class="line"><a name="l00028"></a><span class="lineno"><a class="line" href="../../da/dad/classCBbbGpioCore.html#a5dbf22e49403a26b2e9a9a1fdb8e5312">   28</a></span>&#160;<a class="code" href="../../da/dad/classCBbbGpioCore.html#a5dbf22e49403a26b2e9a9a1fdb8e5312">CBbbGpioCore::~CBbbGpioCore</a>()</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;{</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;    PUSH_FUNC;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;    <a class="code" href="../../da/dad/classCBbbGpioCore.html#a2082607ad6f16d82f40bf85e814e6438">_cds_handler</a>.reset();</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;}</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div>
<div class="line"><a name="l00035"></a><span class="lineno"><a class="line" href="../../da/dad/classCBbbGpioCore.html#a53b5561c5741716645686d858e03d8ea">   35</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../da/dad/classCBbbGpioCore.html#a53b5561c5741716645686d858e03d8ea">CBbbGpioCore::config</a>()</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;{</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;    PUSH_FUNC;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;    <span class="comment">//  fd_adc5 = open(&quot;/sys/bus/iio/devices/iio:device0/in_voltage5_raw&quot;, O_RDONLY);</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    <span class="comment">//  if (fd_adc5 &lt; 0) {</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    <span class="comment">//      SVR_ERR(0, &quot;Cannot open ADC file: %s&quot;, strerror(errno));</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    <span class="comment">//      // throw init_err();</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    <span class="comment">//      // We will press on, just can&#39;t get ADC readings</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    <span class="comment">//  }</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    <span class="comment">//  else {</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    <span class="comment">//      SVR_LOG_DEBUG(SVR_LOG_HW_COMMS, 2, &quot;ADC file opened&quot;);</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    <span class="comment">//  }</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    <span class="comment">// Create the Actor we need for CDS callbacks</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    <span class="comment">// Use the default value for the CDS connection timeout here</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    <a class="code" href="../../da/dad/classCBbbGpioCore.html#a2082607ad6f16d82f40bf85e814e6438">_cds_handler</a>.reset( <span class="keyword">new</span> <a class="code" href="../../d2/d3d/classCGpioCdsHandler.html">CGpioCdsHandler</a>( <a class="code" href="../../da/dad/classCBbbGpioCore.html#aa16dcc22a4404e614d38ef3dc8adb9dc">getptr</a>() ) );</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    <span class="comment">// Then log into the CDS and establish our session token</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    <span class="comment">// Will throw px::generic_err in the unlikely case where this login fails.</span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    <a class="code" href="../../da/dad/classCBbbGpioCore.html#a2082607ad6f16d82f40bf85e814e6438">_cds_handler</a>-&gt;cds_login();</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    <span class="comment">// Test a few of the necessary permissions; assume that we can read Devices and Channels</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    <span class="keywordflow">if</span> ( !<a class="code" href="../../da/dad/classCBbbGpioCore.html#a2082607ad6f16d82f40bf85e814e6438">_cds_handler</a>-&gt;check_permission( px::permissions::internal_app ) )</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    {</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;        <a class="code" href="../../d4/d3d/log_8hpp.html#a0269b3d73432e244e6f398f124878854">SVR_ERR</a>( 0, <span class="stringliteral">&quot;FAILED: Lack permission to create Channels.&quot;</span> );</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;        <span class="keywordflow">throw</span> <a class="code" href="../../d6/d6a/structCBbbGpioCore_1_1init__err.html">init_err</a>( <span class="stringliteral">&quot;FAILED: Lack permission to create Channels.&quot;</span> );</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    }</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    <span class="keywordflow">if</span> ( !<a class="code" href="../../da/dad/classCBbbGpioCore.html#a2082607ad6f16d82f40bf85e814e6438">_cds_handler</a>-&gt;check_permission( px::permissions::data_write ) )</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    {</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;        <a class="code" href="../../d4/d3d/log_8hpp.html#a0269b3d73432e244e6f398f124878854">SVR_ERR</a>( 0, <span class="stringliteral">&quot;FAILED: Lack permission to update Channels.&quot;</span> );</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;        <span class="keywordflow">throw</span> <a class="code" href="../../d6/d6a/structCBbbGpioCore_1_1init__err.html">init_err</a>( <span class="stringliteral">&quot;FAILED: Lack permission to update Channels.&quot;</span> );</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    }</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    <span class="comment">// Else, ready to go</span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    <a class="code" href="../../d4/d3d/log_8hpp.html#a0b08cce399b8c9670277fee95242c1e1">SVR_INFO</a>( 5, <span class="stringliteral">&quot;Logged into the CDS and have sufficient permissions to proceed.&quot;</span> );</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    <span class="comment">// Set the parent device communication status</span></div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <a class="code" href="../../da/dad/classCBbbGpioCore.html#a2082607ad6f16d82f40bf85e814e6438">_cds_handler</a>-&gt;set_device_communicating( <a class="code" href="../../da/dad/classCBbbGpioCore.html#a437e71677d5392d39e3ab75dc46e6e16">_parent_id</a>, <span class="keyword">true</span> );</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;}</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div>
<div class="line"><a name="l00076"></a><span class="lineno"><a class="line" href="../../da/dad/classCBbbGpioCore.html#a55ebc6e828f44fb5ee9417f2603709f0">   76</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../da/dad/classCBbbGpioCore.html#a55ebc6e828f44fb5ee9417f2603709f0">CBbbGpioCore::execute</a>()</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;{</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    PUSH_FUNC;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    <span class="comment">/* Will use an ASIO Manager to manage Watchdog, subscription callbacks, and signal alerts. */</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    std::shared_ptr&lt;px::asio::CIoManager&gt; manager;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    <span class="keywordflow">try</span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    {</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;        manager.reset( <span class="keyword">new</span> px::asio::CIoManager( *<span class="keyword">this</span>, *<a class="code" href="../../da/dad/classCBbbGpioCore.html#a2082607ad6f16d82f40bf85e814e6438">_cds_handler</a>, <a class="code" href="../../da/dad/classCBbbGpioCore.html#af5a266cc3d468bd7f5accb9d2ff3c279">_options</a>-&gt;watchdog_timeout ) );</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;        <span class="comment">// If you need a periodic timer, start it here:</span></div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;        <span class="comment">// _your_timer = px::asio::CMsecTimer::create( *manager, _your_handler.get(), msec_timeout );</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    }</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    <span class="keywordflow">catch</span> ( <span class="keyword">const</span> boost::system::system_error &amp;e )</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    {</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;        <span class="comment">// TODO: handle this</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;        <a class="code" href="../../d4/d3d/log_8hpp.html#a0269b3d73432e244e6f398f124878854">SVR_ERR</a>( 0, <span class="stringliteral">&quot;System error encountered in setting up I/O manager: %s&quot;</span>, e.what() );</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    }</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    <span class="keywordflow">if</span> ( manager.get() )    <span class="comment">// if we created a valid IO Manager</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    {</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;        <span class="comment">// Now initialize the channels</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;        <a class="code" href="../../da/dad/classCBbbGpioCore.html#a20020adb8729a612faa2e2ad99ece4ec">_led_channel</a>.reset( <span class="keyword">new</span> <a class="code" href="../../d8/d4b/classCBbbTricolorLED.html">CBbbTricolorLED</a>( <a class="code" href="../../da/dad/classCBbbGpioCore.html#a437e71677d5392d39e3ab75dc46e6e16">_parent_id</a>, <a class="code" href="../../da/dad/classCBbbGpioCore.html#a2082607ad6f16d82f40bf85e814e6438">_cds_handler</a> ) );</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;        assert( <a class="code" href="../../da/dad/classCBbbGpioCore.html#a20020adb8729a612faa2e2ad99ece4ec">_led_channel</a> );</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;        <span class="comment">// Kick off the GPIO access by initializing and reading the present color of the LED</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;        <a class="code" href="../../da/dad/classCBbbGpioCore.html#a20020adb8729a612faa2e2ad99ece4ec">_led_channel</a>-&gt;initialize_channel();</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;        <span class="comment">// Now that we have a manager and ASIO framework, we can subscribe</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;        <a class="code" href="../../da/dad/classCBbbGpioCore.html#a20020adb8729a612faa2e2ad99ece4ec">_led_channel</a>-&gt;subscribe_channel();</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;        <span class="keywordflow">try</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;        {</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;            <a class="code" href="../../d4/d3d/log_8hpp.html#aaca55a0846fdbaae5bca426f4e59ab70">SVR_DEBUG</a>( 2, <span class="stringliteral">&quot;Entering the run() loop&quot;</span> );</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;            <span class="comment">// This will block indefinitely, and do all the real work of</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;            <span class="comment">// the server</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;            manager-&gt;run();</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        }</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;        <span class="keywordflow">catch</span> ( <span class="keyword">const</span> boost::system::system_error &amp;e )</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;        {</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;            <span class="comment">// TODO: handle this</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;            <a class="code" href="../../d4/d3d/log_8hpp.html#a0269b3d73432e244e6f398f124878854">SVR_ERR</a>( 0, <span class="stringliteral">&quot;System error encountered in I/O manager: %s&quot;</span>, e.what() );</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;        }</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;        <a class="code" href="../../d4/d3d/log_8hpp.html#aaca55a0846fdbaae5bca426f4e59ab70">SVR_DEBUG</a>( 2, <span class="stringliteral">&quot;Exiting the run() loop&quot;</span> );</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;        <span class="comment">// Closeout, if we haven&#39;t already, and free our resources.</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;        <a class="code" href="../../da/dad/classCBbbGpioCore.html#a2082607ad6f16d82f40bf85e814e6438">_cds_handler</a>-&gt;unsubscribe_channel( <a class="code" href="../../da/dad/classCBbbGpioCore.html#a20020adb8729a612faa2e2ad99ece4ec">_led_channel</a>-&gt;id() );</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;        manager-&gt;quit();</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;        manager.reset();</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    }</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;}</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;</div>
<div class="line"><a name="l00129"></a><span class="lineno"><a class="line" href="../../da/dad/classCBbbGpioCore.html#a01b67a148bf8a87307b88c925e475213">  129</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../da/dad/classCBbbGpioCore.html#a01b67a148bf8a87307b88c925e475213">CBbbGpioCore::shutdown</a>()</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;{</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    PUSH_FUNC;</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    <a class="code" href="../../da/dad/classCBbbGpioCore.html#a20020adb8729a612faa2e2ad99ece4ec">_led_channel</a>.reset();</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;}</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;</div>
<div class="line"><a name="l00136"></a><span class="lineno"><a class="line" href="../../da/dad/classCBbbGpioCore.html#aa16dcc22a4404e614d38ef3dc8adb9dc">  136</a></span>&#160;std::shared_ptr&lt;CBbbGpioCore&gt; <a class="code" href="../../da/dad/classCBbbGpioCore.html#aa16dcc22a4404e614d38ef3dc8adb9dc">CBbbGpioCore::getptr</a>()</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;{</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;    <span class="keywordflow">return</span> ( this-&gt;shared_from_this() );</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;}</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="comment">// The following GPIO functions were suggested by</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="comment">// http://www.black-swift.com/wiki/index.php?title=Working_with_GPIOs_%28C/C%2B%2B%29</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="comment">// though I have Eatonized them some.</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;<span class="comment">// Initialize the I/O actions for the given GPIO by adding it to the export file.</span></div>
<div class="line"><a name="l00146"></a><span class="lineno"><a class="line" href="../../da/dad/classCBbbGpioCore.html#ad52b4f31c1e662407470b9fdf193fe87">  146</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="../../da/dad/classCBbbGpioCore.html#ad52b4f31c1e662407470b9fdf193fe87">CBbbGpioCore::enable_gpio_pin</a>( uint32_t gpio_pin, uid_t proc_owner )</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;{</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    PUSH_FUNC;</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    <span class="keywordtype">char</span> buf[64];</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    <span class="keywordtype">int</span> fd = open( <span class="stringliteral">&quot;/sys/class/gpio/export&quot;</span>, O_WRONLY );</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    <span class="keywordflow">if</span> ( fd &lt; 0 )</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    {</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;        <a class="code" href="../../d4/d3d/log_8hpp.html#a0269b3d73432e244e6f398f124878854">SVR_ERR</a>( 0, <span class="stringliteral">&quot;Failed to open enable for GPIO #%u -- %s&quot;</span>, gpio_pin, strerror( errno ) );</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;        <span class="keywordflow">return</span> ( <span class="keyword">false</span> );</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    }</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    snprintf( buf, 64, <span class="stringliteral">&quot;%u&quot;</span>, gpio_pin );</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    ssize_t bytes = write( fd, buf, strlen( buf ) );</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    close( fd );</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    <span class="comment">// An error of EBUSY means that the filesystem for this GPIO pin already exists</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    <span class="keywordflow">if</span> ( ( bytes &lt;= 0 ) &amp;&amp; ( errno != EBUSY ) )</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    {</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        <a class="code" href="../../d4/d3d/log_8hpp.html#a0269b3d73432e244e6f398f124878854">SVR_ERR</a>( 0, <span class="stringliteral">&quot;Failed to enable GPIO #%u -- %s&quot;</span>, gpio_pin, strerror( errno ) );</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        <span class="keywordflow">return</span> ( <span class="keyword">false</span> );</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    }</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    <span class="comment">// Now change the owner of the particular files we care to write to in its filesystem area</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    <span class="comment">// $ ls /sys/class/gpio/gpio7</span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    <span class="comment">// active_low  direction   edge        power       subsystem   uevent      value</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span> fnames[3][12] = { <span class="stringliteral">&quot;direction&quot;</span>, <span class="stringliteral">&quot;edge&quot;</span>, <span class="stringliteral">&quot;value&quot;</span> };</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    <span class="keywordflow">for</span> ( <span class="keywordtype">size_t</span> i = 0; i &lt; 3; i++ )</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    {</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;        snprintf( buf, 64, <span class="stringliteral">&quot;/sys/class/gpio/gpio%u/%s&quot;</span>, gpio_pin, fnames[i] );</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;        <span class="comment">// Leave the group GID unchanged (-1)</span></div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;        <span class="keywordtype">int</span> result = chown( buf, proc_owner, -1 );</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;        <span class="keywordflow">if</span> ( result &lt; 0 )</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        {</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;            <a class="code" href="../../d4/d3d/log_8hpp.html#a0269b3d73432e244e6f398f124878854">SVR_ERR</a>( 0, <span class="stringliteral">&quot;Failed to enable process-level access for %s for UID = %u -- %s&quot;</span>,</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;                     buf, proc_owner, strerror( errno ) );</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;            <span class="keywordflow">return</span> ( <span class="keyword">false</span> );</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;        }</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    }</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    <span class="comment">// else, success</span></div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    <a class="code" href="../../d4/d3d/log_8hpp.html#aaca55a0846fdbaae5bca426f4e59ab70">SVR_DEBUG</a>( 5, <span class="stringliteral">&quot;Enabled GPIO #%u and access for UID = %u&quot;</span>, gpio_pin, proc_owner );</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    <span class="keywordflow">return</span> ( <span class="keyword">true</span> );</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;}</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;<span class="comment">// Set the direction for the given GPIO pin for input or output.</span></div>
<div class="line"><a name="l00189"></a><span class="lineno"><a class="line" href="../../da/dad/classCBbbGpioCore.html#ab51f90c047c53fd278b3e5c7c0e8b12d">  189</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="../../da/dad/classCBbbGpioCore.html#ab51f90c047c53fd278b3e5c7c0e8b12d">CBbbGpioCore::set_gpio_direction</a>( uint32_t gpio_pin, <span class="keywordtype">bool</span> is_input )   <span class="comment">// 1 for output, 0 for input</span></div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;{</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    PUSH_FUNC;</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    <span class="keywordtype">char</span> buf[64];</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    snprintf( buf, 64, <span class="stringliteral">&quot;/sys/class/gpio/gpio%u/direction&quot;</span>, gpio_pin );</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    <span class="keywordtype">int</span> fd = open( buf, O_WRONLY );</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    <span class="keywordflow">if</span> ( fd &lt; 0 )</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    {</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;        <a class="code" href="../../d4/d3d/log_8hpp.html#a0269b3d73432e244e6f398f124878854">SVR_ERR</a>( 0, <span class="stringliteral">&quot;Failed to set direction for GPIO #%u&quot;</span>, gpio_pin );</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;        <span class="keywordflow">return</span> ( <span class="keyword">false</span> );</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    }</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    ssize_t bytes;</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    <span class="keywordflow">if</span> ( is_input )</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    {</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;        bytes = write( fd, <span class="stringliteral">&quot;in&quot;</span>, 2 );</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    }</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    {</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        bytes = write( fd, <span class="stringliteral">&quot;out&quot;</span>, 3 );</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    }</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    close( fd );</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    <span class="keywordflow">if</span> ( bytes &lt;= 0 )</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    {</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;        <a class="code" href="../../d4/d3d/log_8hpp.html#a0269b3d73432e244e6f398f124878854">SVR_ERR</a>( 0, <span class="stringliteral">&quot;Failed to set direction for GPIO #%u&quot;</span>, gpio_pin );</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;        <span class="keywordflow">return</span> ( <span class="keyword">false</span> );</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    }</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    <span class="comment">// else, success</span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    <a class="code" href="../../d4/d3d/log_8hpp.html#aaca55a0846fdbaae5bca426f4e59ab70">SVR_DEBUG</a>( 5, <span class="stringliteral">&quot;Set direction for GPIO #%u to \&quot;%s\&quot;&quot;</span>, gpio_pin, is_input ? <span class="stringliteral">&quot;in&quot;</span> : <span class="stringliteral">&quot;out&quot;</span> );</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    <span class="keywordflow">return</span> ( <span class="keyword">true</span> );</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;}</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="comment">// Read the given GPIO input and return the result of active (high, 1) or inactive (low, 0)</span></div>
<div class="line"><a name="l00223"></a><span class="lineno"><a class="line" href="../../da/dad/classCBbbGpioCore.html#aa7f108f2bdead633515a27e0d469637b">  223</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="../../da/dad/classCBbbGpioCore.html#aa7f108f2bdead633515a27e0d469637b">CBbbGpioCore::get_gpio</a>( uint32_t gpio_pin, <span class="keywordtype">bool</span> &amp;is_active )</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;{</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    PUSH_FUNC;</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    <span class="keywordtype">char</span> buf[64];</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    snprintf( buf, 64, <span class="stringliteral">&quot;/sys/class/gpio/gpio%u/value&quot;</span>, gpio_pin );</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <span class="keywordtype">int</span> fd = open( buf, O_RDONLY );</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    <span class="keywordflow">if</span> ( fd &lt; 0 )</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    {</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;        <a class="code" href="../../d4/d3d/log_8hpp.html#a0269b3d73432e244e6f398f124878854">SVR_ERR</a>( 0, <span class="stringliteral">&quot;Failed to get input for GPIO #%u&quot;</span>, gpio_pin );</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;        <span class="keywordflow">return</span> ( <span class="keyword">false</span> );</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    }</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    memset( buf, 0, 64 );</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    ssize_t bytes = read( fd, buf, 1 );     <span class="comment">// just read 1 byte</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    close( fd );</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    <span class="keywordflow">if</span> ( bytes &lt;= 0 )</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    {</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;        <a class="code" href="../../d4/d3d/log_8hpp.html#a0269b3d73432e244e6f398f124878854">SVR_ERR</a>( 0, <span class="stringliteral">&quot;Failed to read input for GPIO #%u&quot;</span>, gpio_pin );</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;        <span class="keywordflow">return</span> ( <span class="keyword">false</span> );</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;    }</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    <span class="keywordflow">if</span> ( buf[0] == <span class="charliteral">&#39;0&#39;</span> )</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    {</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;        is_active = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    }</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    {</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        is_active = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    }</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    <span class="comment">// else, success</span></div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    <a class="code" href="../../d4/d3d/log_8hpp.html#aaca55a0846fdbaae5bca426f4e59ab70">SVR_DEBUG</a>( 5, <span class="stringliteral">&quot;Read input for GPIO #%u as \&quot;%s\&quot;&quot;</span>, gpio_pin, is_active ? <span class="stringliteral">&quot;active&quot;</span> : <span class="stringliteral">&quot;inactive&quot;</span> );</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    <span class="keywordflow">return</span> ( <span class="keyword">true</span> );</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;}</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="comment">// Set the given GPIO output to active (high, 1) or inactive (low, 0)</span></div>
<div class="line"><a name="l00257"></a><span class="lineno"><a class="line" href="../../da/dad/classCBbbGpioCore.html#ac3d9dfabd264f526d6d2bbf417c4a4b7">  257</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="../../da/dad/classCBbbGpioCore.html#ac3d9dfabd264f526d6d2bbf417c4a4b7">CBbbGpioCore::set_gpio</a>( uint32_t gpio_pin, <span class="keywordtype">bool</span> is_active )</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;{</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    PUSH_FUNC;</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;    <span class="keywordtype">char</span> buf[64];</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    snprintf( buf, 64, <span class="stringliteral">&quot;/sys/class/gpio/gpio%u/value&quot;</span>, gpio_pin );</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    <span class="keywordtype">int</span> fd = open( buf, O_WRONLY );</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    <span class="keywordflow">if</span> ( fd &lt; 0 )</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    {</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;        <a class="code" href="../../d4/d3d/log_8hpp.html#a0269b3d73432e244e6f398f124878854">SVR_ERR</a>( 0, <span class="stringliteral">&quot;Failed to set output for GPIO #%u&quot;</span>, gpio_pin );</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;        <span class="keywordflow">return</span> ( <span class="keyword">false</span> );</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    }</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;    snprintf( buf, 64, <span class="stringliteral">&quot;%s&quot;</span>, is_active ? <span class="stringliteral">&quot;1&quot;</span> : <span class="stringliteral">&quot;0&quot;</span> );</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    ssize_t bytes = write( fd, buf, 1 );</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    close( fd );</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    <span class="keywordflow">if</span> ( bytes &lt;= 0 )</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    {</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;        <a class="code" href="../../d4/d3d/log_8hpp.html#a0269b3d73432e244e6f398f124878854">SVR_ERR</a>( 0, <span class="stringliteral">&quot;Failed to set output for GPIO #%u&quot;</span>, gpio_pin );</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;        <span class="keywordflow">return</span> ( <span class="keyword">false</span> );</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    }</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    <span class="comment">// else, success</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    <a class="code" href="../../d4/d3d/log_8hpp.html#aaca55a0846fdbaae5bca426f4e59ab70">SVR_DEBUG</a>( 5, <span class="stringliteral">&quot;Set output for GPIO #%u to \&quot;%s\&quot;&quot;</span>, gpio_pin, is_active ? <span class="stringliteral">&quot;active&quot;</span> : <span class="stringliteral">&quot;inactive&quot;</span> );</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    <span class="keywordflow">return</span> ( <span class="keyword">true</span> );</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;}</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="comment">/*  This function is currently not used; see CSyntheticChannels::set_channel_states() instead.</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;<span class="comment">   bool CBbbAdcDhCore::set_communicating(px::id_t chanid, bool comm_state) const</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;<span class="comment">   {</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="comment">    PUSH_FUNC;</span></div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;<span class="comment">    SVR_LOG_INFO(SVR_LOG_CDS, 1, &quot;Setting channel %ju state to %s communicating&quot;,</span></div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;<span class="comment">                 chanid, comm_state?&quot;IS&quot;:&quot;NOT&quot;);</span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;<span class="comment">    px::cds::CSetChannelState scs_msg;</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;<span class="comment">    std::shared_ptr&lt;px::cds::CSetChannelState&gt; scs_reply;</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;<span class="comment">    px::CBitset&lt;px::realtime_state&gt; states;</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="comment">    states.set(px::realtime_state::not_communicating);</span></div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;<span class="comment">    px::cds::state_op op = comm_state ? px::cds::state_op::op_clear_flags :</span></div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="comment">        px::cds::state_op::op_set_flags;</span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;<span class="comment">    scs_msg.channels.emplace_back(chanid, states, op);</span></div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;<span class="comment">    scs_reply = std::dynamic_pointer_cast&lt;px::cds::CSetChannelState&gt;(px::cds::CClient::get()-&gt;submit_wait(scs_msg));</span></div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="comment">    if (unlikely((!scs_reply) || (scs_reply-&gt;channels.empty()))) {</span></div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="comment">        SVR_ERR(0, &quot;Bad response to SetChannelState&quot;);</span></div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;<span class="comment">        return false;</span></div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;<span class="comment">    }</span></div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;<span class="comment">    if (!scs_reply-&gt;channels[0].succeeded) {</span></div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;<span class="comment">        SVR_ERR(0, &quot;Failed to set channel state&quot;);</span></div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;<span class="comment">        return false;</span></div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="comment">    }</span></div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;<span class="comment">    return true;</span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;<span class="comment">   }</span></div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;</div>
<div class="ttc" id="classCBbbGpioCore_html_a55ebc6e828f44fb5ee9417f2603709f0"><div class="ttname"><a href="../../da/dad/classCBbbGpioCore.html#a55ebc6e828f44fb5ee9417f2603709f0">CBbbGpioCore::execute</a></div><div class="ttdeci">void execute()</div><div class="ttdoc">Run the program&amp;#39;s main loop. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d02/bbb__gpio__core_8cpp_source.html#l00076">bbb_gpio_core.cpp:76</a></div></div>
<div class="ttc" id="classCBbbGpioCore_html_a53b5561c5741716645686d858e03d8ea"><div class="ttname"><a href="../../da/dad/classCBbbGpioCore.html#a53b5561c5741716645686d858e03d8ea">CBbbGpioCore::config</a></div><div class="ttdeci">void config()</div><div class="ttdoc">Do any setup necessary before the main loop is started. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d02/bbb__gpio__core_8cpp_source.html#l00035">bbb_gpio_core.cpp:35</a></div></div>
<div class="ttc" id="classCBbbGpioCore_html_a01b67a148bf8a87307b88c925e475213"><div class="ttname"><a href="../../da/dad/classCBbbGpioCore.html#a01b67a148bf8a87307b88c925e475213">CBbbGpioCore::shutdown</a></div><div class="ttdeci">void shutdown()</div><div class="ttdoc">Do any cleanup necessary when cleanly exiting the main loop. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d02/bbb__gpio__core_8cpp_source.html#l00129">bbb_gpio_core.cpp:129</a></div></div>
<div class="ttc" id="structCBbbGpioCore_1_1init__err_html"><div class="ttname"><a href="../../d6/d6a/structCBbbGpioCore_1_1init__err.html">CBbbGpioCore::init_err</a></div><div class="ttdoc">Custom exception, called if initialization fatally fails. </div><div class="ttdef"><b>Definition:</b> <a href="../../de/ddb/bbb__gpio__core_8hpp_source.html#l00026">bbb_gpio_core.hpp:26</a></div></div>
<div class="ttc" id="classCBbbGpioCore_html_ab51f90c047c53fd278b3e5c7c0e8b12d"><div class="ttname"><a href="../../da/dad/classCBbbGpioCore.html#ab51f90c047c53fd278b3e5c7c0e8b12d">CBbbGpioCore::set_gpio_direction</a></div><div class="ttdeci">static bool set_gpio_direction(uint32_t gpio_pin, bool is_input)</div><div class="ttdoc">Set the direction for the given GPIO pin for input or output. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d02/bbb__gpio__core_8cpp_source.html#l00189">bbb_gpio_core.cpp:189</a></div></div>
<div class="ttc" id="bbb__gpio_8hpp_html_a36f5d02f9285599ac97ddf6ff741f53c"><div class="ttname"><a href="../../d8/da6/bbb__gpio_8hpp.html#a36f5d02f9285599ac97ddf6ff741f53c">SLEEP_INTERVAL_MS</a></div><div class="ttdeci">#define SLEEP_INTERVAL_MS</div><div class="ttdoc">Define the sleep interval we will use for the timebase of this device handler. </div><div class="ttdef"><b>Definition:</b> <a href="../../d8/da6/bbb__gpio_8hpp_source.html#l00030">bbb_gpio.hpp:30</a></div></div>
<div class="ttc" id="bbb__gpio_8hpp_html_aee1e362085b33fb6d9010e7ed4103939"><div class="ttname"><a href="../../d8/da6/bbb__gpio_8hpp.html#aee1e362085b33fb6d9010e7ed4103939">DEFAULT_DEVICE_ID</a></div><div class="ttdeci">#define DEFAULT_DEVICE_ID</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/da6/bbb__gpio_8hpp_source.html#l00032">bbb_gpio.hpp:32</a></div></div>
<div class="ttc" id="bbb__gpio__core_8hpp_html"><div class="ttname"><a href="../../de/ddb/bbb__gpio__core_8hpp.html">bbb_gpio_core.hpp</a></div></div>
<div class="ttc" id="classCBbbTricolorLED_html"><div class="ttname"><a href="../../d8/d4b/classCBbbTricolorLED.html">CBbbTricolorLED</a></div><div class="ttdoc">Simple class to implement the TriColor LED of the BBBlack Bacon Cape via the BBB GPIO pins...</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d37/bbb__tricolor__led_8hpp_source.html#l00021">bbb_tricolor_led.hpp:21</a></div></div>
<div class="ttc" id="classCGpioCdsHandler_html"><div class="ttname"><a href="../../d2/d3d/classCGpioCdsHandler.html">CGpioCdsHandler</a></div><div class="ttdoc">BBB GPIO&amp;#39;s CDS Handler class (an ASIO Actor, specialized for bbb_gpio). </div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d96/gpio__cds__handler_8hpp_source.html#l00029">gpio_cds_handler.hpp:29</a></div></div>
<div class="ttc" id="log_8hpp_html_aaca55a0846fdbaae5bca426f4e59ab70"><div class="ttname"><a href="../../d4/d3d/log_8hpp.html#aaca55a0846fdbaae5bca426f4e59ab70">SVR_DEBUG</a></div><div class="ttdeci">#define SVR_DEBUG(__VLVL__,...)</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d3d/log_8hpp_source.html#l00198">log.hpp:198</a></div></div>
<div class="ttc" id="bbb__gpio_8hpp_html_a51e7cf38f83d1d190fbc926396058131"><div class="ttname"><a href="../../d8/da6/bbb__gpio_8hpp.html#a51e7cf38f83d1d190fbc926396058131">DEFAULT_CH_ID</a></div><div class="ttdeci">#define DEFAULT_CH_ID</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/da6/bbb__gpio_8hpp_source.html#l00033">bbb_gpio.hpp:33</a></div></div>
<div class="ttc" id="classCBbbGpioCore_html_a20020adb8729a612faa2e2ad99ece4ec"><div class="ttname"><a href="../../da/dad/classCBbbGpioCore.html#a20020adb8729a612faa2e2ad99ece4ec">CBbbGpioCore::_led_channel</a></div><div class="ttdeci">std::shared_ptr&lt; CBbbTricolorLED &gt; _led_channel</div><div class="ttdoc">Holds the instance of our GPIO channel, for a TriColor LED. </div><div class="ttdef"><b>Definition:</b> <a href="../../de/ddb/bbb__gpio__core_8hpp_source.html#l00143">bbb_gpio_core.hpp:143</a></div></div>
<div class="ttc" id="classCBbbGpioCore_html_aa7f108f2bdead633515a27e0d469637b"><div class="ttname"><a href="../../da/dad/classCBbbGpioCore.html#aa7f108f2bdead633515a27e0d469637b">CBbbGpioCore::get_gpio</a></div><div class="ttdeci">static bool get_gpio(uint32_t gpio_pin, bool &amp;is_active)</div><div class="ttdoc">Read the given GPIO input and return the result of active (high, 1) or inactive (low, 0) (Some implementations may take the opposite view, but for the BBB LED pins, high is active) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d02/bbb__gpio__core_8cpp_source.html#l00223">bbb_gpio_core.cpp:223</a></div></div>
<div class="ttc" id="classCBbbGpioCore_html_af999ee98dae951642f0e45cd7a31fef0"><div class="ttname"><a href="../../da/dad/classCBbbGpioCore.html#af999ee98dae951642f0e45cd7a31fef0">CBbbGpioCore::CBbbGpioCore</a></div><div class="ttdeci">CBbbGpioCore(std::shared_ptr&lt; COptions &gt; options)</div><div class="ttdoc">Public Member Functions. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d02/bbb__gpio__core_8cpp_source.html#l00015">bbb_gpio_core.cpp:15</a></div></div>
<div class="ttc" id="gpio__cds__handler_8hpp_html"><div class="ttname"><a href="../../d1/d96/gpio__cds__handler_8hpp.html">gpio_cds_handler.hpp</a></div></div>
<div class="ttc" id="classCBbbGpioCore_html_aa16dcc22a4404e614d38ef3dc8adb9dc"><div class="ttname"><a href="../../da/dad/classCBbbGpioCore.html#aa16dcc22a4404e614d38ef3dc8adb9dc">CBbbGpioCore::getptr</a></div><div class="ttdeci">std::shared_ptr&lt; CBbbGpioCore &gt; getptr()</div><div class="ttdoc">Getter for shared_ptr to &amp;quot;this&amp;quot;. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d02/bbb__gpio__core_8cpp_source.html#l00136">bbb_gpio_core.cpp:136</a></div></div>
<div class="ttc" id="classCBbbGpioCore_html_a2082607ad6f16d82f40bf85e814e6438"><div class="ttname"><a href="../../da/dad/classCBbbGpioCore.html#a2082607ad6f16d82f40bf85e814e6438">CBbbGpioCore::_cds_handler</a></div><div class="ttdeci">std::shared_ptr&lt; CGpioCdsHandler &gt; _cds_handler</div><div class="ttdoc">The ASIO handler for subscriptions and submitting to the CDS. </div><div class="ttdef"><b>Definition:</b> <a href="../../de/ddb/bbb__gpio__core_8hpp_source.html#l00140">bbb_gpio_core.hpp:140</a></div></div>
<div class="ttc" id="log_8hpp_html_a0269b3d73432e244e6f398f124878854"><div class="ttname"><a href="../../d4/d3d/log_8hpp.html#a0269b3d73432e244e6f398f124878854">SVR_ERR</a></div><div class="ttdeci">#define SVR_ERR(__VLVL__,...)</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d3d/log_8hpp_source.html#l00182">log.hpp:182</a></div></div>
<div class="ttc" id="classCBbbGpioCore_html_a437e71677d5392d39e3ab75dc46e6e16"><div class="ttname"><a href="../../da/dad/classCBbbGpioCore.html#a437e71677d5392d39e3ab75dc46e6e16">CBbbGpioCore::_parent_id</a></div><div class="ttdeci">px::id_t _parent_id</div><div class="ttdoc">Private Member Functions. </div><div class="ttdef"><b>Definition:</b> <a href="../../de/ddb/bbb__gpio__core_8hpp_source.html#l00134">bbb_gpio_core.hpp:134</a></div></div>
<div class="ttc" id="log_8hpp_html_a0b08cce399b8c9670277fee95242c1e1"><div class="ttname"><a href="../../d4/d3d/log_8hpp.html#a0b08cce399b8c9670277fee95242c1e1">SVR_INFO</a></div><div class="ttdeci">#define SVR_INFO(__VLVL__,...)</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d3d/log_8hpp_source.html#l00194">log.hpp:194</a></div></div>
<div class="ttc" id="classCBbbGpioCore_html_a5dbf22e49403a26b2e9a9a1fdb8e5312"><div class="ttname"><a href="../../da/dad/classCBbbGpioCore.html#a5dbf22e49403a26b2e9a9a1fdb8e5312">CBbbGpioCore::~CBbbGpioCore</a></div><div class="ttdeci">~CBbbGpioCore()</div><div class="ttdoc">Destructor, if any last cleanup is needed. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d02/bbb__gpio__core_8cpp_source.html#l00028">bbb_gpio_core.cpp:28</a></div></div>
<div class="ttc" id="classCBbbGpioCore_html_ad52b4f31c1e662407470b9fdf193fe87"><div class="ttname"><a href="../../da/dad/classCBbbGpioCore.html#ad52b4f31c1e662407470b9fdf193fe87">CBbbGpioCore::enable_gpio_pin</a></div><div class="ttdeci">static bool enable_gpio_pin(uint32_t gpio_pin, uid_t proc_owner)</div><div class="ttdoc">Initialize the I/O actions for the given GPIO by adding it to the export file and changing the owner ...</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d02/bbb__gpio__core_8cpp_source.html#l00146">bbb_gpio_core.cpp:146</a></div></div>
<div class="ttc" id="classCBbbGpioCore_html_ac3d9dfabd264f526d6d2bbf417c4a4b7"><div class="ttname"><a href="../../da/dad/classCBbbGpioCore.html#ac3d9dfabd264f526d6d2bbf417c4a4b7">CBbbGpioCore::set_gpio</a></div><div class="ttdeci">static bool set_gpio(uint32_t gpio_pin, bool is_active)</div><div class="ttdoc">Set the given GPIO output to active (high, 1) or inactive (low, 0) (Some implementations may take the...</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d02/bbb__gpio__core_8cpp_source.html#l00257">bbb_gpio_core.cpp:257</a></div></div>
<div class="ttc" id="classCBbbGpioCore_html_af5a266cc3d468bd7f5accb9d2ff3c279"><div class="ttname"><a href="../../da/dad/classCBbbGpioCore.html#af5a266cc3d468bd7f5accb9d2ff3c279">CBbbGpioCore::_options</a></div><div class="ttdeci">std::shared_ptr&lt; COptions &gt; _options</div><div class="ttdoc">Our copy of the application Options. </div><div class="ttdef"><b>Definition:</b> <a href="../../de/ddb/bbb__gpio__core_8hpp_source.html#l00137">bbb_gpio_core.hpp:137</a></div></div>
<div class="ttc" id="bbb__tricolor__led_8hpp_html"><div class="ttname"><a href="../../d5/d37/bbb__tricolor__led_8hpp.html">bbb_tricolor_led.hpp</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../dir_b2f33c71d4aa5e7af42a1ca61ff5af1b.html">source</a></li><li class="navelem"><a class="el" href="../../d6/d02/bbb__gpio__core_8cpp.html">bbb_gpio_core.cpp</a></li>
    <li class="footer">Generated on Fri May 7 2021 20:17:49 for BeagleBoneGPIODeviceHandler by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.5 </li>
  </ul>
</div>
</body>
</html>
