<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>IoT Agent: /src/product-ref1/px-toolkit/etn_source/iot_agent/docs/iot_send_messages.md Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Eaton_Red_Toolbox_Logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">IoT Agent
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d1/d15/iot__send__messages_8md.html','../../');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">/src/product-ref1/px-toolkit/etn_source/iot_agent/docs/iot_send_messages.md</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d1/d15/iot__send__messages_8md.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="preprocessor"># Description of Publishing and Message Types in IoT Agent {#iot_send_messages}</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;To be more economical and less burdensome on the cloud processing, edge devices like those <span class="keyword">using</span> the PX Red IoT Agent <span class="keywordflow">try</span> to maximize the one-way publishing of data (Device-to-Cloud, D2C), and minimize the request-response paradigm (<span class="keyword">using</span> Cloud-to-Device (C2D) requests).</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;An important aspect of <span class="keyword">this</span> design is the use of IoT Device Profiles, known to both the device and cloud but not transferred or <span class="stringliteral">&quot;discovered&quot;</span>, to enumerate the channels of interest <span class="keywordflow">for</span> a given device model. The channel data can then be sent to Azure <span class="keyword">using</span> just the numeric <span class="stringliteral">&quot;tag&quot;</span> to identify the channel, but both sides agree on what that channel is.</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;## Message Types <span class="keywordflow">for</span> Published data</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;There are just a small set of message types <span class="keywordflow">for</span> publishing data currently defined in the Eaton IoT Device SDK:</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;| Name | Contents | Notes |</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;| ---- | -------- | ----- |</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;| <span class="stringliteral">&quot;DeviceTree&quot;</span> | The iot_data_device_item structure <span class="keywordflow">for</span> device data | Nested structure, starting with the Publisher Device, and including state values |</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;| <span class="stringliteral">&quot;DevicesRealtimes&quot;</span> | The iot_data_devices_realtime_item structure <span class="keywordflow">for</span> device state | Just used <span class="keywordflow">for</span> the Publisher device as a heartbeat; ignored by PX White |</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;| <span class="stringliteral">&quot;Realtimes&quot;</span> | A LIST of iot_data_channel_realtimes_item structures; each entry provides the present value <span class="keywordflow">for</span> one Channel | Also includes the timestamp (in secs and msecs) and (useless) state values |</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;| &quot;Trends&quot; | A LIST of iot_data_trend_item structures; each entry provides the trend parameters (any of min/avg/max/actual) for the last complete interval | Also includes the timestamp of the interval end (in secs) |</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">### Realtime Channel data</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;In Azure, <span class="stringliteral">&quot;Realtimes&quot;</span> are also described as <span class="stringliteral">&quot;See-Me&quot;</span> data, since only the last received value is kept and accessible (ie, there is no history or archiving of <span class="keyword">this</span> data).</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;The timestamps <span class="keywordflow">for</span> Realtimes are as given by the CDS <span class="keywordflow">for</span> when the value was last updated (normally by the Device Handler that gets the channel data from a device and writes it to the CDS).</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;### Channel Trend data</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;In Azure, <span class="stringliteral">&quot;Trends&quot;</span> are also described as <span class="stringliteral">&quot;Store-Me&quot;</span> data, since the records are archived and the history can be retrieved <span class="keywordflow">for</span> displaying Trends in the data.</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;The IoT Device Profile declares which channels are trended, and with which of the four trend traits (minimum, average, maximum, and actual). </div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;These four traits correspond to the trend traits that the PX Red CDS stores, and the trend records are queried from the CDS databases. The CDS trend interval is fixed at 5 minutes, and the traits describe the data seen by the CDS within that interval; the <span class="stringliteral">&quot;actual&quot;</span> value is the last value seen before the end of the interval.</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;The timestamp <span class="keywordflow">for</span> Trend data is the rounded time of the end of the interval (normally :00, :05, :10, etc minutes in each hour) expressed in seconds since the Linux Epoch (Jan 1, 1970) in the UTC timeframe.</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor">### Special Trend messages: Realtimes as Trends, Routed Channel List</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;If the build configuration calls <span class="keywordflow">for</span> it, the IoT Agent can publish a message of the Trends type but only containing <span class="stringliteral">&quot;actual&quot;</span> values from the CDS channel values at the end of the interval. The timestamp <span class="keywordflow">for</span> these messages is that of the end of interval being reported (not the channel update times). Since these are sent as Trends messages, they will be archived by PX White. There are two types:</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;In the <span class="stringliteral">&quot;Realtimes as Trends&quot;</span> <span class="keywordflow">case</span>, the present values <span class="keywordflow">for</span> all channels (in the IoT Device Profile) are sent, regardless of whether the profile calls from them to be trended or with the <span class="stringliteral">&quot;actual&quot;</span> trend trait. This provides a snapshot of all the channels every 5 minutes. Note that <span class="keyword">this</span> does include <span class="keyword">static</span> channel values, since no distinction is made between <span class="keyword">static</span> (eg, configuration) and dynamic (time varying) channels in the profile.</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;In the <span class="stringliteral">&quot;Routed Channel List&quot;</span> <span class="keywordflow">case</span>, the product build provides an IotRoutedChannelList OOB which lists just the channels to be sent as part of <span class="keyword">this</span> message <span class="keywordflow">for</span> any device with these channels. This OOB also specifies the routing target name to be included with <span class="keyword">this</span> message as the special <span class="stringliteral">&quot;r&quot;</span> parameter. When PX White receives <span class="keyword">this</span> message and sees the <span class="stringliteral">&quot;r&quot;</span> parameter, it does not archive the data itself, but routes the message to the indicated target (another cloud provider or Azure site).</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;Three thoughts on the use of the rounded interval timestamp applied to <span class="keyword">this</span> Realtime data: </div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;* The time of the last actual update of the channel is lost in <span class="keyword">this</span> approach.</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;* However, the value given is the last known value at that point in time, so it presumed to be nearly correct.</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;* The advantage <span class="keywordflow">for</span> data analytics is that the data is given as all readings <span class="keyword">synchronized</span> to permit coherent transforms and comparisons at one point in time.</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;## Publishing description and the <a class="code" href="../../dd/d68/classCIotDeviceClient.html">CIotDeviceClient</a> timer task</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;Another aspect is to determine when to send which data, to keep the cloud updated without incurring unnecessary expense <span class="keywordflow">for</span> sending unnecessary data. To <span class="keywordflow">do</span> <span class="keyword">this</span>, the following principles are currently used:</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;* The current or last values <span class="keywordflow">for</span> all profiled channels of each devices are published once at the time of connection to Azure, <span class="keyword">using</span> the <span class="stringliteral">&quot;Realtimes&quot;</span> message.</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;* At connection time, the iot_agent also checks each device to see <span class="keywordflow">if</span> the CDS has trend data from the last interval available <span class="keywordflow">for</span> it, and publishes that too <span class="keywordflow">if</span> it is available.</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;* At (almost) every run of the <a class="code" href="../../dd/d68/classCIotDeviceClient.html">CIotDeviceClient</a> timer task, it checks to see if there are any changes (updates) in the channel values for each device, and publishes these changed values in the Realtimes message.</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;* The first time the timer task runs after the trend interval is closed,</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;  * It publishes all of the channel values as Realtimes (per an agreement with PX White), even if they haven&#39;t been updated.</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;  * If the &quot;Realtimes as Trends&quot; is enabled by the build, it sends these message(s).</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;  * If the &quot;Routed Channel List&quot; is enabled, it sends these message(s).</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;* The <a class="code" href="../../dd/d68/classCIotDeviceClient.html">CIotDeviceClient</a> timer task also checks to see if it is time to publish Trends data from the CDS (ie, once every 5 minutes), and, if so, publishes the last trend interval&#39;s data for each device.</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;  * The timing of this is not simply right after the end of the 5 minute interval, as you might expect; instead, the timer task waits until at least 2 minutes after the interval ended, to make sure that the CDS has had enough time to close the interval and make all of its data available.</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;  * It also publishes the DeviceRealTimes (ie, state) message just for the Publisher device at this time, as a heartbeat. In this way, even if the devices have no data to send, the iot_agent does send at least one message every trend interval.</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;The <a class="code" href="../../dd/d68/classCIotDeviceClient.html">CIotDeviceClient</a> timer task is paced by an ASIO Timer, which invokes the <a class="code" href="../../dd/d68/classCIotDeviceClient.html">CIotDeviceClient</a>::handle_timer_update() to execute this task. The default update interval of _UPDATE_TIMER_MSECS is set to 1 second, so this is the normal timebase on which this task is run. (It can be varied for unusual circumstances, such as reconnection delays.)</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;Note that the Realtimes and Trends publishing is on a per-device basis; that is, the data for each device is published in a messages separate from that of the other device data messages.</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="preprocessor">### Setting the Cadence for Realtimes to a non-default interval</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;As described above, the normal cadence <span class="keywordflow">for</span> publishing Realtimes data is 1s and <span class="keywordflow">for</span> Trends it is 5 minutes; <span class="keyword">this</span> provides the most responsive update rate. However, to economize data publishing, a product can be built to use a different cadence, by setting the CONFIG_IOT_REALTIME_CADENCE_SECS build variable.</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;If <span class="keyword">this</span> is set to an interval of less than 5 minutes, then the Realtimes will be updated only at <span class="keyword">this</span> interval, but Trends will remain at 5 minutes.</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;If <span class="keyword">this</span> is set to an intervalgreater than, or equal to, 5 minutes (the only valid choices are 5 minutes, 15 minutes, 1 hour, and 24 hours), then both the Realtimes and Trends will only be updated at <span class="keyword">this</span> interval.</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;### Trend Catch-up</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;[This is a <span class="keyword">new</span> feature under development.]</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;</div>
<div class="ttc" id="classCIotDeviceClient_html"><div class="ttname"><a href="../../dd/d68/classCIotDeviceClient.html">CIotDeviceClient</a></div><div class="ttdoc">Actor that creates a Client IoT Device client and manages its connection to the Azure IoT Hub...</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/dab/iot__device__client_8hpp_source.html#l00068">iot_device_client.hpp:68</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d1/d15/iot__send__messages_8md.html">iot_send_messages.md</a></li>
    <li class="footer">Generated on Fri May 7 2021 20:26:03 for IoT Agent by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.5 </li>
  </ul>
</div>
</body>
</html>
