<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>IoT Agent: /src/product-ref1/px-toolkit/etn_source/iot_agent/docs/iot_threading.md Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Eaton_Red_Toolbox_Logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">IoT Agent
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d2/d34/iot__threading_8md.html','../../');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">/src/product-ref1/px-toolkit/etn_source/iot_agent/docs/iot_threading.md</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d2/d34/iot__threading_8md.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="preprocessor"># Threading in the IoT Agent {#md_iot_threading}</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="preprocessor">## Main program thread</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;* After initialization and daemonization, Boost ASIO manages the pseudo-multi-tasking of the various Actors.</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;* Everything here is <span class="keyword">event</span>-driven; the <a class="code" href="../../d5/de9/group__iot__startup.html#ga0ddf1224851353fc92bfbff6f499fa97">main</a> <span class="stringliteral">&quot;event&quot;</span>  the process Timer going off.</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;* Based on Boost::ASIO library (see the LibPX cumentation)</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;* After initialization, IOT code should &lt;em&gt;never&lt;/em&gt; call blockable or synchronous functions (except in ASIO)</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="preprocessor">## CDS Background thread</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;* From the libpx CDS Client</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;* Launched when the program initializes its CDS connection</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;* While IoT Agent code could <span class="keyword">interface </span>directly with CDS Client methods, instead we are relying on the CdsHandler class to be our interface the CDS.</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;* The background thread will call our registered callback functions when something of subscribed interest happens (eg, device or Channel change or update)</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">## Azure thread</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;* Not too sure of the details of <span class="keyword">this</span> thread, but be aware that there is one.</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;* This thread is allowed to run whenever the DoWork() function is called.</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;* The Azure code relies on the IoT Agent implementation for some thread utilities, such as ThreadAPI_Sleep().</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;* The rest are provided by the pthread library, which is linked to the Azure code.</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">## Net Diagnostics thread</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;When the attempt to connect fails and the IoT Agent needs to diagnose the reasons why, it launches a thread</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;to run the Net Diagnostics task in the <a class="code" href="../../da/d95/classCNetDiag.html">CNetDiag</a> <span class="keyword">class</span>.</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;* The C++11 std::async() and std::future are used to launch the thread and get the results of the task.</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;* The task is a run-to-completion task, which can involve a number of steps and take a few minutes to complete.</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor">## Trend Catchup thread</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;If, after connecting, the IoT Agent determines that there are old trend intervals which need to be published</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;to PX White, it launches a thread to slowly query and publish those missing trend intervals.</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;* This is found in the <a class="code" href="../../db/db5/classTrendManager.html">TrendManager</a> <span class="keyword">class</span>.</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;* The C++11 std::async() and std::future are used to launch the thread and get the results of the task.</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;* The task is a run-to-completion task, which could run for some time before all the trends have been published.</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;* It paces itself both by using a 10s sleep between actions, and by ensuring that the published messages are all</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;acknowledged before considering an interval &quot;caught up&quot; and moving on to the next one.</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="preprocessor">## IOT Blob Upload Thread</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;* This thread is found in <a class="code" href="../../d4/dd8/classBlobUploadManager.html">BlobUploadManager</a> Class.</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;* The C++11 std::async() and std::future are used to launch this thread and get results of the thread.</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;* Every 5 secs(configurable by variable in IoT Agent device client), the pending list (map) will be checked and if pending uploads found, launch this thread to take care of the pending uploads. </div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;* There will be a separate thread for each fle upload which will run to completition.</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;* The thread will lock the pending list, copy the contents into a local list, clear the pending list and release the lock.</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;* The thread will be completed after all OOBs in the local list are processed.</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;* In the blob upload, there is another thread for the blob upload catch up task. In case the blob uploads are interrupted due to system or network issues, they will be re-attempted when IoT Agent re-connects. This thread is also launched using C++11 std::async() and std::future.</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;[Module for IoT Threading](@ref iot_threading)</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div>
<div class="ttc" id="classBlobUploadManager_html"><div class="ttname"><a href="../../d4/dd8/classBlobUploadManager.html">BlobUploadManager</a></div><div class="ttdoc">Class to manage Blob uploads, handling the requests and response through OOB/. </div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d64/blob__upload__manager_8hpp_source.html#l00019">blob_upload_manager.hpp:19</a></div></div>
<div class="ttc" id="classCNetDiag_html"><div class="ttname"><a href="../../da/d95/classCNetDiag.html">CNetDiag</a></div><div class="ttdoc">The class to diagnose and report on connection issues. </div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d6d/netdiag_8hpp_source.html#l00024">netdiag.hpp:24</a></div></div>
<div class="ttc" id="group__iot__startup_html_ga0ddf1224851353fc92bfbff6f499fa97"><div class="ttname"><a href="../../d5/de9/group__iot__startup.html#ga0ddf1224851353fc92bfbff6f499fa97">main</a></div><div class="ttdeci">int main(int argc, char *argv[])</div><div class="ttdoc">The program entry point, main(). </div><div class="ttdef"><b>Definition:</b> <a href="../../df/d0a/main_8cpp_source.html#l00222">main.cpp:222</a></div></div>
<div class="ttc" id="classTrendManager_html"><div class="ttname"><a href="../../db/db5/classTrendManager.html">TrendManager</a></div><div class="ttdoc">Class to manage the Trend publishing and other trend-related services. </div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc3/trend__manager_8hpp_source.html#l00022">trend_manager.hpp:22</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d2/d34/iot__threading_8md.html">iot_threading.md</a></li>
    <li class="footer">Generated on Fri May 7 2021 20:26:03 for IoT Agent by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.5 </li>
  </ul>
</div>
</body>
</html>
