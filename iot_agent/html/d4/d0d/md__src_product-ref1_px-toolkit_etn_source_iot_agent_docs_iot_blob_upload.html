<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>IoT Agent: IOT Blob Upload</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Eaton_Red_Toolbox_Logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">IoT Agent
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d4/d0d/md__src_product-ref1_px-toolkit_etn_source_iot_agent_docs_iot_blob_upload.html','../../');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">IOT Blob Upload </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Iot blob upload feature is used for uploading device data files as blobs to PX-White using Eaton and Azure SDKs.</p>
<h1>Prerequisite for using IOT Blob upload:</h1>
<p>1) Product needs to update "CONFIG_EATON_IOT_BLOB_ENABLE" to 'Y' for enabling feature. By default its set to 'N'. 2) IOT Agent should be Running. 3) IOTBlobUpload/filename OOB. This OOB can be created and deleted at product level.</p>
<h1>Feature Info :</h1>
<ul>
<li>Product team will initialize IOTBlobUpload/filename OOB with the file path, timestamp(optional) to be passed to PXWhite as blob timestamp, blob type and the CDS device id for which the file stores the channel/event data.</li>
<li>IOT Agent will be subscribed to OOB and will be notified when created and updated.</li>
<li>When subscription callback is received, the OOB will be checked for the request and response fields. If response is present, the OOB will be added to the pending list only if the result is INTERRUPTED and the retry count is less than the max allowed retries (set to 3 in PXRed). If no response is present, the OOB will be considered newly created and will be added to the pending uploads map.</li>
<li>Every 5 secs(configurable by variable in IoT Agent device client), the pending list (map) will be checked and if pending uploads found, launch a thread to take care of the pending uploads.</li>
<li>The thread will lock the pending list, copy the contents into a local list, clear the pending list and release the lock.</li>
<li>For each item in the local list, IoT Agent will read the OOB and get the device id, file path, blob type and timestamps. Get the UUID from the device, open and read the file content into a buffer and pass these along with timestamp to the Eaton SDK blob upload function. These arguments would be concatenated to form the blobpath before passing to the EatonSDK.</li>
<li>If the timestamp is not passed by the user, current timestamp will be used. And it will be written back to the OOB during setting the response to help the user to query the blob. Time can be specified upto miliseconds as "2020-01-01 12:12:12.123"</li>
<li>Eaton SDK after processing the arguments, send the request to Azure SDK.</li>
<li>Azure SDK responds with a success/fail once the blob upload is completed.</li>
<li>Status of the upload is stored back into the OOB for each file and retry_count is updated.</li>
<li>Thread will be completed after all OOBs in the local list are processed.</li>
</ul>
<h1>How to test blob upload on BBB:</h1>
<ol type="1">
<li>Log in to the BBB.</li>
<li>Start IOT Agent</li>
<li>Create a data file in file system under “/initlo/data” location. Add some text data in the file.</li>
<li>mkdir -p /initlo/data/blob ; vi /initlo/data/blob/testupload.txt</li>
<li>Create an OOB - " cdscmd -soj IotBlobUpload/uploadfile1 '{ "toolkitStruct":{ "iot_blob_upload":{ "blob_up_request": { "device_id":1, "filepath":"blob/testupload.txt", "blobtype":"firmware", "timestamp": { "sec": 1589448182, "nsec": 5 } } } } }' -pt pa -vv "</li>
<li>We can check whether OOB IotBlobUpload/uploadfile1 is created using the “cdscmd -got Iot” command.</li>
</ol>
<ol type="1">
<li>Check Upload Status - "cdscmd -go IotBlobUpload/uploadfile1 -pp "</li>
<li>Sample response recieved on executing above command : { "toolkitStruct": { "iot_blob_upload": { "blob_up_request": { "device_id":1, "filepath":"blob/testupload.txt", "blobtype":"firmware", "timestamp": { "sec":1589448182, "nsec":5 } }, "blob_up_response": { "result":"IOT_BLOB_UPLOAD_DONE_SUCCESS", "resp_msg":"Successfully uploaded the file blob/testupload.txt.", "retry_count":1, "blob_path":"b511f5af-9a76-539a-801d-bba3764bc82b/firmware/2020-05-14/09-23-02-500" } } } }</li>
</ol>
<h2>Use Swagger to check blob contents and list</h2>
<p>To fetch the uploaded blobs through Swagger APIs, the device UUID, timestamp of the blob and blob type are required.User will need access to IOT hub swagger page.</p>
<ul>
<li>Log into Swagger, using the URL of your IoT Hub.</li>
</ul>
<p>We can use GET /api/v1/devices/{id}/blobs to fetch blob content for particular blob:</p>
<ol type="1">
<li>In Blob tab click GET /api/v1/devices/{id}/blobs</li>
<li>Enter Device ID,Blobtype &amp; time.and click "Try it out".</li>
<li>Ensure all time parameters are specified in correct format eg: '2015-09-01T14:30:56.123Z'</li>
<li>Gets the blob content from a device (identified by the device uuid), and based on the blob type and the blob timestamp.</li>
</ol>
<p>Alternatively we can use GET /api/v1/devices/{id}/blobs/list Api under Blobs tab :</p>
<ol type="1">
<li>In Blob tab click GET /api/v1/devices/{id}/blobs/list</li>
<li>Time part under parameter is optional only date can be passed to fetch result.</li>
<li>Gets the list of blobs timestamps from a device, based on the blob_type and a time range. It will return no more than 5000 items. A device shall never push more than 5000 blobs per day. The 204 status code will be returned if the list is empty. </li>
</ol>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri May 7 2021 20:26:03 for IoT Agent by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.5 </li>
  </ul>
</div>
</body>
</html>
