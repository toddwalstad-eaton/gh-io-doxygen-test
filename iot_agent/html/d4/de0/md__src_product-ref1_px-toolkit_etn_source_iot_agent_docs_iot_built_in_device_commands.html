<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>IoT Agent: IoT Agent built-in Device Commands</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Eaton_Red_Toolbox_Logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">IoT Agent
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d4/de0/md__src_product-ref1_px-toolkit_etn_source_iot_agent_docs_iot_built_in_device_commands.html','../../');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">IoT Agent built-in Device Commands </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Iot built in device commands is a feature added to the iot_agent to pass and execute various commands over cloud to a px-red device which is connected to cloud.</p>
<h2>Device Command Schema</h2>
<p>Device command sent from the cloud to device:</p>
<p>```json { "who": "&lt;user_uuid&gt;", // Optional. The cloud shall send the command requester's id. "id": "&lt;command_instance_uuid&gt;", // Required. The command instance uuid. This can be used to track a command's execution lifecycle. "d": "&lt;device_uuid&gt;", // Optional. The target device uuid. "method": "&lt;MethodName&gt;", // Required. Defined by the device profile. Recommended to use Camel case to identify the commands. Only letter // and digits are allowed. No any other characters shall be allowed, such as spaces or underscores. The first // character must be a letter. "params": {"param1":"value1", "param2":"value2", ...} // Optional. A list of input parameters and the values. The actual parameters key value pairs are defined // differently for different commands. // Example: "args" : "-got NETWORK", "IsHardReset":"True" } ```</p>
<p>Device command response from the device to the cloud:</p>
<p>```json { "id": "&lt;command_instance_uuid&gt;", // Required. The command instance uuid. Each command shall have one response. "status": &lt;int&gt;, // Required. See the reference of the HTTP Response Code. "msg": "&lt;string&gt;", // Required. This field will contain the output parameter values. "params": {"param1":"value1", "param2":"value2", ...} // Optional. A list of output parameters and the values. The same naming convention for the input params applies. } ```</p>
<p>The Generic device commands to be sent from the Swagger interfce must be mapped to the PX-Red Commands using the schema mentioned at (<a href="http://cipt0534.nam.ci.root:8090/display/LNXTK/PX+Red+Generic+Device+Commands+Mapping">http://cipt0534.nam.ci.root:8090/display/LNXTK/PX+Red+Generic+Device+Commands+Mapping</a>)</p>
<h2>How to add your own new Generic Device Command support:</h2>
<ul>
<li>Adopter needs to create a mapping json file which will map the adopter generic device command schema to the PX-Red schema.</li>
<li>This file should be stored in the adopter repository <code>rootfs/etc/cds/generic/</code> directory. The file should be named something like <b>99_adopter_iot_generic_dev_cmds.json</b>.</li>
<li>When the firmware is built, the file will be placed in the <code>/etc/cds/generic/</code> directory.</li>
<li>With this json file present on device at correct path, during start up the cds will process this json file and update the <b>IotBuiltInCommands/&lt;product&gt;</b> oob with all device commands listed in json file. Then authenticated user can send any of these commands from Swagger interface to the device connected to cloud.</li>
<li><p class="startli">If Adopter wants to add any new command during runtime then above steps should be followed and then the device must be rebooted so that the cds will process the mapping json file and update the <b>IotBuiltInCommands/&lt;product&gt;</b> oob with the newly added command.</p>
<p class="startli"><code>Note</code>: Swagger request <b>method</b> property must match PX Red <b>oobs[x].data.generic_table[y].label</b> property. This is the key to the mapping schema.</p>
</li>
</ul>
<h2>How it works:</h2>
<ul>
<li>When the user sends a command from the swagger interface, the iot agent will look for the command <b>method</b> property in the PX-Red IotBuiltInCommands/&lt;product&gt; OOB <b>label</b> field.</li>
<li>If found, then the the IoT Agent will form the command line string from the request received and then shell out and execute these commands in a shell, then return the response line(s) in the "msg" parameter of the response (Except for GetField and SetField, which are examples of coded commands.)</li>
</ul>
<h3>Command Enhancements:</h3>
<ul>
<li>PX-Red iot_agent enhances the commands by adding arguments like timeout and redirection to know exactly what gets executed.</li>
</ul>
<h4>Timeout:</h4>
<ul>
<li>A timeout is added to the commands before sending to shell to get a timely response from commands. This is especially required for commands which run continuously until interrupted. (For example, ping command).</li>
<li>Current timeout is 10seconds for all commands.</li>
</ul>
<h4>Redirection:</h4>
<ul>
<li>The output redirection <em>2&gt;&amp;1</em> is added to the shell command to redirect the stderr output to the stdout so that we get the complete output with errors and log messages combined.</li>
</ul>
<h2>Examples showing the Swagger and PX Red Generic Device Command Schemas:</h2>
<h3>Method: Adopter Specific Generic Command</h3>
<p>The PX-Red Command Schema for this command to be added in <b>99_adopter_iot_generic_dev_cmds.json</b> file will be as below:</p>
<p>```json { "px.tk_proto.config.PersistentConfig": { "oobs": [{ "tag": "IotBuiltInCommands/MyThermostat", "data": { "label": "MyThermostat Device Commands", "generic_table": [{ "label": "SetThermostatTemperatureRange", "value": { "str_val": "/sbin/set_thermo.py -temprange" } }, { label": "GetThermostatTemperatureRange",
                "value": {
                    "str_val": "/sbin/get_thermo.py -temprange" } }] } }] } } ```</p>
<p>Request Paylod: ```json { "method": "SetThermostatTemperatureRange", "params": { "args": "68 78 Fahrenheit" } } ```</p>
<p>For this request, the final command that gets parsed and executed by the PX-Red iot_agent will be: timeout -t &lt;timeout&gt; /sbin/set_thermo.py -temprange 68 78 Fahrenheit 2&gt;&amp;1</p>
<h3>Method: CdsCmd</h3>
<p>PX-Red Command Schema for this command to be added in <b>99_adopter_iot_generic_dev_cmds.json</b> file will be as below: ```json { "px.tk_proto.config.PersistentConfig":{ "oobs": [{ "tag":"IotBuiltInCommands/MyBBB", "data": { "label":"Built In Device Commands for BBB", "generic_table": [{ "label":"CdsCmd", "description":"Built in support to run cdscmd", "value": { "str_val": "cdscmd" } }] } }] } } ```</p>
<p>Single-line response commands</p>
<p>Request Payload: ```json { "method": "CdsCmd", "params": {"args": "-pp -gdg 1"} } ```</p>
<p>For this request, the command that gets parsed and executed by the PX-Red iot_agent will be: timeout -t &lt;timeout&gt; cdscmd -pp -gdg 1 2&gt;&amp;1</p>
<p>Response Payload ```json { "status":200, "msg":"dde53e79-6685-56a5-b75d-901b2e2925f9" } ```</p>
<p>Mutli-line response commands</p>
<p>Request Payload: ```json { "method": "CdsCmd", "params": {"args": "-pp -gr"} } ```</p>
<p>For this request, the command that gets parsed and executed by the PX-Red iot_agent will be: timeout -t &lt;timeout&gt; cdscmd -pp -gr 2&gt;&amp;1</p>
<p>Response Payload ```json { "status":200, "msg":"admin: data_read,data_write,data_admin,config_read,config_write,config_file,install,troubleshoot,control_basic,control_oper,event_ack,security_admin,security_read,per_userViewer: data_read,per_userIoT Agent: data_read,data_write,data_admin,config_read,config_write,config_file,install,event_ack,security_admin,security_read,per_userOperator: data_read,config_read,control_basic,control_oper,event_ack,per_userService Engineer:data_read,data_admin,config_read,config_write,config_file,install,troubleshoot,control_basic,control_oper,event_ack,per_userEngineer: data_read,data_admin,config_read,config_write,install,control_basic,control_oper,event_ack,per_userSecurity Admin: data_read,security_admin,security_read,per_userSecurity Audit: data_read,security_read,per_user" } ```</p>
<p>Embedded json request commands</p>
<p>Request Payload: ```json { "method": "CdsCmd", "params": {"args":"-vv -soj DateTime 
        { \"toolkitStruct":{ "datetime_settings":{ "ntp_enabled":true, "use_dhcp_ntp_servers":false, "ipv4_ntp_servers":[ "151.110.126.15", "0.pool.ntp.org", "1.pool.ntp.org"] }, "description":"Default NTP settings and UTC timestamp"} } } } ```</p>
<ul>
<li>For this request, the command that gets parsed and executed by the PX-Red iot_agent will be: timeout -t &lt;timeout&gt; cdscmd -vv -soj DateTime '{"toolkitStruct": {"datetime_settings": {"ntp_enabled": true,"use_dhcp_ntp_servers": false,"ipv4_ntp_servers": ["151.110.126.15", "0.pool.ntp.org", "1.pool.ntp.org"]},"description": "Default NTP settings and UTC timestamp"}}' 2&gt;&amp;1</li>
</ul>
<p>Response Payload</p>
<p>```json { "status":200, "msg":"Connecting to CDS... Done!Setting 1 OOB data objects, persist value = paWaiting for CDS to finish processing our commandsDisconnecting from CDS" } ```</p>
<h3>Method: GetField</h3>
<p>Example below shows the GetField command to get a field value of an OOB data "IotConnectionStatus" from CDS.</p>
<p>PX-Red Command Schema required to be added in <b>99_adopter_iot_generic_dev_cmds.json</b> file will be as below: ```json { "px.tk_proto.config.PersistentConfig":{ "oobs": [{ "tag":"IotBuiltInCommands/MyBBB", "data": { "label":"Built In Device Commands for BBB", "generic_table": [{ "label":"GetField", "description":"Supported built in get field device command", "value": { "str_val": "" }, "comments": "params:'TagName' must be valid OOB tag, 'Field' must be valid field in the OOB to get value for OOB." }] } }] } } ```</p>
<p>Request Payload: ```json { "method": "GetField", "params": {"TagName": "IotConnectionStatus", "Field": "iot_connection_status.traffic_count"} } ```</p>
<p>Response Payload: ```json { "status": 200, "msg": "217" } ```</p>
<h3>Method: SetField</h3>
<p>Example below shows the SetField command to set a field value of an OOB data "IotConnectionStatus" from CDS.</p>
<p>PX-Red Command Schema required for mapping: ```json { "px.tk_proto.config.PersistentConfig":{ "oobs": [{ "tag":"IotBuiltInCommands/MyBBB", "data": { "label":"Built In Device Commands for BBB", "generic_table": [{ "label":"SetField", "description":"Supported built in set field device command", "value": { "str_val": "" }, "comments": "params:'TagName' must be valid OOB tag, 'Field' must be valid field in the OOB, 'Value' must be value to set for OOB." }] } }] } } ```</p>
<p>Request Payload: ```json { "method": "SetField", "params": {"TagName": "IotConnectionStatus", "Field": "iot_connection_status.traffic_count", "Value" : "10"} } ``` Response Payload: ```json { "status": 200, "msg": "OK" } ```</p>
<h2>**CommandScript** type of commands details</h2>
<ul>
<li>Using this command user can run any linux command or program of his choice on the device, but required that the privileges are of <b>iot_agent</b> and not root.</li>
<li>Inclusion of this command for an adopter is potentially dangerous option, as almost any command could be sent to the device leading to harmful threats. Hence it is recommended not to add this command in your release code or shippable products.</li>
</ul>
<h3>Method: CommandScript</h3>
<ul>
<li>Example below shows the CommandScript command to execute a script present on the device to get the alarm information for a particular device.</li>
<li>Here, the param 'command' holds the command to be executed, the shell script in this case and the param 'args' holds the argument to be passed to the command if any. In this case, we pass the device id for which the alarm information is needed.</li>
</ul>
<p>Request Payload: ```json { "method": "CommandScript", "params": {"command":"/tmp/DevAlarmInfo.sh", "args":"1"} } ```</p>
<p>Response Payload: ```json { "status":200, "msg":"{ 
        \"AlarmUpdate":{ "alarm_id":1154, "sequence_index":0, "update_global_count":2309, "time":{ "sec":1538130426, "nsec":289164229 }, "device_id":1, "channel_id":64, "value":{ "bool_val":true, "str_val":"True" }, "realtime_state":{ "disabled":false, "disarmed":false, "not_communicating":false, "pass_through":false, "waveform_available":false }, "latching":true, "alarm_closed":false, "trigger":{ "level":1, "trigger_type":"ON_VALUE", "threshold":{ "bool_val":true }, "priority":5000, "custom_message":"Persistent data storage is corrupted. Check system log." }, "ack_level":0, "trigger_condition_cleared":false, "first_occur_time":{ "sec":1538130426, "nsec":289164229 }, "max_reached_trigger_level":1, "str_val":"True" } } { "AlarmUpdate":{ "alarm_id":1154, "sequence_index":1, "update_global_count":2310, "time":{ "sec":1538130433, "nsec":154372945 }, "device_id":1, "channel_id":64, "value":{ "bool_val":true, "str_val":"True" }, "realtime_state":{ "disabled":false, "disarmed":false, "not_communicating":false, "pass_through":false, "waveform_available":false }, "latching":true, "alarm_closed":false, "trigger":{ "level":1, "trigger_type":"ON_VALUE", "threshold":{ "bool_val":true }, "priority":5000, "custom_message":"Persistent data storage is corrupted. Check system log." }, "ack_level":1, "trigger_condition_cleared":false, "first_occur_time":{ "sec":1538130426, "nsec":289164229 }, "max_reached_trigger_level":1, "str_val":"True" } } { "AlarmUpdate":{ "alarm_id":1154, "sequence_index":2, "update_global_count":2311, "time":{ "sec":1538130436, "nsec":225537088 }, "device_id":1, "channel_id":64, "value":{ "bool_val":false, "str_val":"False" }, "realtime_state":{ "disabled":false, "disarmed":false, "not_communicating":false, "pass_through":false, "waveform_available":false }, "latching":true, "alarm_closed":true, "trigger":{ "level":1, "trigger_type":"ON_VALUE", "threshold":{ "bool_val":true }, "priority":5000, "custom_message":"Persistent data storage is corrupted. Check system log." }, "ack_level":1, "trigger_condition_cleared":true, "first_occur_time":{ "sec":1538130426, "nsec":289164229 }, "max_reached_trigger_level":1, "str_val":"False" } }" } ```</p>
<h3>For more information on generic device commands please refer the links:</h3>
<p><a href="https://confluence-prod.tcc.etn.com/display/IoTPlatform/R10+Generic+Device+Commands+Design">R10 Generic Device Commands Design</a></p>
<p><a href="https://confluence-prod.tcc.etn.com/display/IoTPlatform/Device+Command">Device Commands</a> </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri May 7 2021 20:26:03 for IoT Agent by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.5 </li>
  </ul>
</div>
</body>
</html>
