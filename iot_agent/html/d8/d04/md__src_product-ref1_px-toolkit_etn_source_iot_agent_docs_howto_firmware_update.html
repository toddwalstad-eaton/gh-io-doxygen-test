<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>IoT Agent: How to - Firmware Update</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Eaton_Red_Toolbox_Logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">IoT Agent
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d8/d04/md__src_product-ref1_px-toolkit_etn_source_iot_agent_docs_howto_firmware_update.html','../../');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">How to - Firmware Update </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Use Swagger to do a Firmware Update</h2>
<p>This is a fairly simple process, once you know the UUID of the Image Blob that you want to use, and the device(s) you want to direct it to. It doesn't matter whether it is a Linux firmware update or a device firmware update; the approach from Swagger is the same, though the UUID(s) of the target device_id(s) would probably be different.</p>
<ol type="1">
<li>Log into Swagger, using the URL of your IoT Hub.</li>
<li>In the Dlm (Device Lifecycle Management) tab, select "PUT /api/v1/dlm/firmware"</li>
<li>Fill out the "dlmInfo" fields. A full example is shown below.<ol type="a">
<li>The "name" is not arbitrary; it must match an image type known to the IoT Agent, such as "LinuxImage". See the <a class="el" href="../../da/d49/md__src_product-ref1_px-toolkit_etn_source_iot_agent_docs_iot_agent_oobs.html#image_version_oob">image_name description</a>.</li>
<li>For the "image_id" field, provide the UUID of the blob.</li>
<li>The "start" field schedules the update job, either for immediate execution or delayed to a given future time and date. Any value for now or in the past will result in immediate execution.</li>
<li>Don't make the timeout value too low. The Swagger UI describes this correctly as *"The timeout parameter (seconds) determine how long the job will execute before the job times out."* For reference, the download time for a 25MB LinuxImage runs about 40 minutes, or 2400 seconds.</li>
</ol>
</li>
<li>Hit the "Try it out!" button to kick it off.</li>
<li>You should get a 200 (HTTP OK) code, and the job UUID. Copy the job UUID.</li>
<li>Open the API box for "GET /api/v1/dlm/firmware/{id}" to learn the status of your Firmware Update job. Paste the Job UUID into the "id" field, and hit "Try it out!".</li>
<li>Be patient; it will take quite a while (maybe 40 minutes) for the download to complete; after that, a Linux firmware update is executed in about 30s. You can check the Job Status to see if it was successful.</li>
</ol>
<p>Example of dlmInfo:</p>
<p>```json { "site_id": "51d2c013-c62c-45a2-a8a7-ae3e2f078051", "name": "LinuxImage", "description": "LinuxImage for BBB R3.19.5", "device_ids": [ "9e2724fa-5634-5771-8e09-4ff16164213a" ], "image_id": "c3afbacb-1bcf-4862-8c20-3b887ef878f4", "start": "2019-07-08T01:00Z", "timeout": 10000 } ```</p>
<h2>How Linux Firmware Update works</h2>
<p>For reference, see the <a href="https://confluence-prod.tcc.etn.com/display/IoTPlatform/Q3+2017+DLM+Service#Q32017DLMService-C2DMessagePayloads">C2D Message Payloads</a>, and the <a href="https://confluence-prod.tcc.etn.com/display/IoTPlatform/Q3+2017+DLM+Service#Q32017DLMService-UpdateFirmwareDataFlow(scenario#1">process flow for Firmware Update</a>).</p>
<ol type="1">
<li>When you start the Firmware Update job, PX White sends a FirmwareUpdate command to the IoT Agent.<ol type="a">
<li>This serves as a sort of "may I?" request, giving the iot_agent the right to refuse to proceed.</li>
<li>The iot_agent doesn't answer this on its own; instead, it opens a shell to run the update_linux_image program, with the "check_version" action.</li>
<li>If that program returns an OK, the iot_agent returns a success response to PX White.</li>
</ol>
</li>
<li>Then the iot_agent takes the next step; it sends a TransferImage message to PX White, saying that it is ready to receive the image.</li>
<li>PX White begins sending chunks of the base64-encoded image, using the ImageTransfer command.</li>
<li>When the final chunk of the image is sent, the iot_agent invokes the update_linux_image program, with the "update" action and the name of the downloaded image file in the /tmp folder.</li>
<li>Then the iot_agent sends a series of Command Status updates, ending with one with the final Task set to the magic text "UpdateFirmware".<ol type="a">
<li>"UpdateFirmware" is the key to PX White that this is the final step, whether the status is succeed or fail.</li>
<li>The iot_agent relies on the update_linux_image program to write to an agreed upon ImageUpdate/xxxx OOB for the status updates of its progress and final success or failure. It echoes these in its messages to PX White.</li>
</ol>
</li>
</ol>
<p>Note that, for consistency, the update_linux_image program is used for all three routes to do the firmware update:</p>
<ul>
<li>Azure IoT</li>
<li>CGI script, from the UI</li>
<li>fw_update.sh script, via SSH</li>
</ul>
<h2>How to push an Image Update blob to Azure</h2>
<p>(This area may need revision...)</p>
<h3>Swagger API</h3>
<p>I haven't tried it, but there is an API that claims to do this: under the DLM tab, the "PUT /api/v1/blobs/firmware" operation.</p>
<h3>Windows Command-line utility</h3>
<p>This is a little .NET program named UploadBlob.exe that parses companion file UploadBlob.exe.config to determine the parameters for the blob image and the site to push it to, runs, pushes the blob, and returns the blob UUID.</p>
<p>If you want to use this route, contact the PX White laison and see if this is still recommended (or if there is a better alternative) and to obtain a copy. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri May 7 2021 20:26:03 for IoT Agent by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.5 </li>
  </ul>
</div>
</body>
</html>
