<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>IoT Agent: /src/product-ref1/px-toolkit/etn_source/iot_agent/docs/howto_firmware_update.md Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Eaton_Red_Toolbox_Logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">IoT Agent
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('dc/d21/howto__firmware__update_8md.html','../../');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">/src/product-ref1/px-toolkit/etn_source/iot_agent/docs/howto_firmware_update.md</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../dc/d21/howto__firmware__update_8md.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="preprocessor"># How to - Firmware Update {#howto_firmware_update}</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="preprocessor">## Use Swagger to do a Firmware Update</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;This is a fairly simple process, once you know the UUID of the Image Blob that you want to use, and the device(s) you want to direct it to. It doesn&#39;t matter whether it is a Linux firmware update or a device firmware update; the approach from Swagger is the same, though the UUID(s) of the target device_id(s) would probably be different.</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;1. Log into Swagger, using the URL of your IoT Hub.</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;2. In the Dlm (Device Lifecycle Management) tab, select &quot;PUT /api/v1/dlm/firmware&quot;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;3. Fill out the &quot;dlmInfo&quot; fields. A full example is shown below.</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;   1. The &quot;name&quot; is not arbitrary; it must match an image type known to the IoT Agent, such as &quot;LinuxImage&quot;. See the [image_name description](@ref image_version_oob).</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;   2. For the &quot;image_id&quot; field, provide the UUID of the blob.</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;   3. The &quot;start&quot; field schedules the update job, either for immediate execution or delayed to a given future time and date. Any value for now or in the past will result in immediate execution.</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;   4. Don&#39;t make the timeout value too low. The Swagger UI describes this correctly as *&quot;The timeout parameter (seconds) determine how <span class="keywordtype">long</span> the job will execute before the job times out.&quot;* For reference, the download time for a 25MB LinuxImage runs about 40 minutes, or 2400 seconds.</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;4. Hit the &quot;Try it out!&quot; button to kick it off.</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;5. You should get a 200 (HTTP OK) code, and the job UUID. Copy the job UUID.</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;6. Open the API box for &quot;GET /api/v1/dlm/firmware/{<span class="keywordtype">id</span>}<span class="stringliteral">&quot; to learn the status of your Firmware Update job. Paste the Job UUID into the &quot;</span><span class="keywordtype">id</span><span class="stringliteral">&quot; field, and hit &quot;</span>Try it out!<span class="stringliteral">&quot;.</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="stringliteral">7. Be patient; it will take quite a while (maybe 40 minutes) for the download to complete; after that, a Linux firmware update is executed in about 30s. You can check the Job Status to see if it was successful.</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="stringliteral">Example of dlmInfo:</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="stringliteral">```json</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="stringliteral">{</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="stringliteral">  &quot;</span>site_id<span class="stringliteral">&quot;: &quot;</span>51d2c013-c62c-45a2-a8a7-ae3e2f078051<span class="stringliteral">&quot;,</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="stringliteral">  &quot;</span>name<span class="stringliteral">&quot;: &quot;</span>LinuxImage<span class="stringliteral">&quot;,</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="stringliteral">  &quot;</span>description<span class="stringliteral">&quot;: &quot;</span>LinuxImage <span class="keywordflow">for</span> BBB R3.19.5<span class="stringliteral">&quot;,</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="stringliteral">  &quot;</span>device_ids<span class="stringliteral">&quot;: [</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="stringliteral">    &quot;</span>9e2724fa-5634-5771-8e09-4ff16164213a<span class="stringliteral">&quot;</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="stringliteral">  ],</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="stringliteral">  &quot;</span>image_id<span class="stringliteral">&quot;: &quot;</span>c3afbacb-1bcf-4862-8c20-3b887ef878f4<span class="stringliteral">&quot;,</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="stringliteral">  &quot;</span>start<span class="stringliteral">&quot;: &quot;</span>2019-07-08T01:00Z<span class="stringliteral">&quot;,</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="stringliteral">  &quot;</span>timeout<span class="stringliteral">&quot;: 10000</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="stringliteral">}</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="stringliteral">```</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="stringliteral">## How Linux Firmware Update works</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="stringliteral">For reference, see the [C2D Message Payloads](https://confluence-prod.tcc.etn.com/display/IoTPlatform/Q3+2017+DLM+Service#Q32017DLMService-C2DMessagePayloads), and the [process flow for Firmware Update](https://confluence-prod.tcc.etn.com/display/IoTPlatform/Q3+2017+DLM+Service#Q32017DLMService-UpdateFirmwareDataFlow(scenario#1)).</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="stringliteral">1. When you start the Firmware Update job, PX White sends a FirmwareUpdate command to the IoT Agent.</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="stringliteral">   1. This serves as a sort of &quot;</span>may I?<span class="stringliteral">&quot; request, giving the iot_agent the right to refuse to proceed.</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="stringliteral">   2. The iot_agent doesn&#39;t answer this on its own; instead, it opens a shell to run the update_linux_image program, with the &quot;</span>check_version<span class="stringliteral">&quot; action. </span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="stringliteral">   3. If that program returns an OK, the iot_agent returns a success response to PX White.</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="stringliteral">2. Then the iot_agent takes the next step; it sends a TransferImage message to PX White, saying that it is ready to receive the image.</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="stringliteral">3. PX White begins sending chunks of the base64-encoded image, using the ImageTransfer command.</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="stringliteral">4. When the final chunk of the image is sent, the iot_agent invokes the update_linux_image program, with the &quot;</span>update<span class="stringliteral">&quot; action and the name of the downloaded image file in the /tmp folder.</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="stringliteral">5. Then the iot_agent sends a series of Command Status updates, ending with one with the final Task set to the magic text &quot;</span>UpdateFirmware<span class="stringliteral">&quot;.</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="stringliteral">   1. &quot;</span>UpdateFirmware<span class="stringliteral">&quot; is the key to PX White that this is the final step, whether the status is succeed or fail.</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="stringliteral">   2. The iot_agent relies on the update_linux_image program to write to an agreed upon ImageUpdate/xxxx OOB for the status updates of its progress and final success or failure. It echoes these in its messages to PX White.</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="stringliteral">Note that, for consistency, the update_linux_image program is used for all three routes to do the firmware update:</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="stringliteral">* Azure IoT</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="stringliteral">* CGI script, from the UI</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="stringliteral">* fw_update.sh script, via SSH</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="stringliteral">## How to push an Image Update blob to Azure</span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="stringliteral">(This area may need revision...)</span></div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="stringliteral">### Swagger API</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="stringliteral">I haven&#39;t tried it, but there is an API that claims to do this: under the DLM tab, the &quot;</span>PUT /api/v1/blobs/firmware<span class="stringliteral">&quot; operation.</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="stringliteral">### Windows Command-line utility</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="stringliteral">This is a little .NET program named UploadBlob.exe that parses companion file UploadBlob.exe.config to determine the parameters for the blob image and the site to push it to, runs, pushes the blob, and returns the blob UUID.</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="stringliteral">If you want to use this route, contact the PX White laison and see if this is still recommended (or if there is a better alternative) and to obtain a copy.</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="stringliteral"></span></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../dc/d21/howto__firmware__update_8md.html">howto_firmware_update.md</a></li>
    <li class="footer">Generated on Fri May 7 2021 20:26:02 for IoT Agent by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.5 </li>
  </ul>
</div>
</body>
</html>
