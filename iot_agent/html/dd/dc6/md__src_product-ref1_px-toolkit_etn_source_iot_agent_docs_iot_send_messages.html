<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>IoT Agent: Description of Publishing and Message Types in IoT Agent</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Eaton_Red_Toolbox_Logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">IoT Agent
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('dd/dc6/md__src_product-ref1_px-toolkit_etn_source_iot_agent_docs_iot_send_messages.html','../../');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Description of Publishing and Message Types in IoT Agent </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>To be more economical and less burdensome on the cloud processing, edge devices like those using the PX Red IoT Agent try to maximize the one-way publishing of data (Device-to-Cloud, D2C), and minimize the request-response paradigm (using Cloud-to-Device (C2D) requests).</p>
<p>An important aspect of this design is the use of IoT Device Profiles, known to both the device and cloud but not transferred or "discovered", to enumerate the channels of interest for a given device model. The channel data can then be sent to Azure using just the numeric "tag" to identify the channel, but both sides agree on what that channel is.</p>
<h2>Message Types for Published data</h2>
<p>There are just a small set of message types for publishing data currently defined in the Eaton IoT Device SDK:</p>
<table class="doxtable">
<tr>
<th>Name </th><th>Contents </th><th>Notes  </th></tr>
<tr>
<td>"DeviceTree" </td><td>The iot_data_device_item structure for device data </td><td>Nested structure, starting with the Publisher Device, and including state values </td></tr>
<tr>
<td>"DevicesRealtimes" </td><td>The iot_data_devices_realtime_item structure for device state </td><td>Just used for the Publisher device as a heartbeat; ignored by PX White </td></tr>
<tr>
<td>"Realtimes" </td><td>A LIST of iot_data_channel_realtimes_item structures; each entry provides the present value for one Channel </td><td>Also includes the timestamp (in secs and msecs) and (useless) state values </td></tr>
<tr>
<td>"Trends" </td><td>A LIST of iot_data_trend_item structures; each entry provides the trend parameters (any of min/avg/max/actual) for the last complete interval </td><td>Also includes the timestamp of the interval end (in secs) </td></tr>
</table>
<h3>Realtime Channel data</h3>
<p>In Azure, "Realtimes" are also described as "See-Me" data, since only the last received value is kept and accessible (ie, there is no history or archiving of this data).</p>
<p>The timestamps for Realtimes are as given by the CDS for when the value was last updated (normally by the Device Handler that gets the channel data from a device and writes it to the CDS).</p>
<h3>Channel Trend data</h3>
<p>In Azure, "Trends" are also described as "Store-Me" data, since the records are archived and the history can be retrieved for displaying Trends in the data. The IoT Device Profile declares which channels are trended, and with which of the four trend traits (minimum, average, maximum, and actual).</p>
<p>These four traits correspond to the trend traits that the PX Red CDS stores, and the trend records are queried from the CDS databases. The CDS trend interval is fixed at 5 minutes, and the traits describe the data seen by the CDS within that interval; the "actual" value is the last value seen before the end of the interval.</p>
<p>The timestamp for Trend data is the rounded time of the end of the interval (normally :00, :05, :10, etc minutes in each hour) expressed in seconds since the Linux Epoch (Jan 1, 1970) in the UTC timeframe.</p>
<h3>Special Trend messages: Realtimes as Trends, Routed Channel List</h3>
<p>If the build configuration calls for it, the IoT Agent can publish a message of the Trends type but only containing "actual" values from the CDS channel values at the end of the interval. The timestamp for these messages is that of the end of interval being reported (not the channel update times). Since these are sent as Trends messages, they will be archived by PX White. There are two types:</p>
<p>In the "Realtimes as Trends" case, the present values for all channels (in the IoT Device Profile) are sent, regardless of whether the profile calls from them to be trended or with the "actual" trend trait. This provides a snapshot of all the channels every 5 minutes. Note that this does include static channel values, since no distinction is made between static (eg, configuration) and dynamic (time varying) channels in the profile.</p>
<p>In the "Routed Channel List" case, the product build provides an IotRoutedChannelList OOB which lists just the channels to be sent as part of this message for any device with these channels. This OOB also specifies the routing target name to be included with this message as the special "r" parameter. When PX White receives this message and sees the "r" parameter, it does not archive the data itself, but routes the message to the indicated target (another cloud provider or Azure site).</p>
<p>Three thoughts on the use of the rounded interval timestamp applied to this Realtime data:</p>
<ul>
<li>The time of the last actual update of the channel is lost in this approach.</li>
<li>However, the value given is the last known value at that point in time, so it presumed to be nearly correct.</li>
<li>The advantage for data analytics is that the data is given as all readings synchronized to permit coherent transforms and comparisons at one point in time.</li>
</ul>
<h2>Publishing description and the <a class="el" href="../../dd/d68/classCIotDeviceClient.html" title="Actor that creates a Client IoT Device client and manages its connection to the Azure IoT Hub...">CIotDeviceClient</a> timer task</h2>
<p>Another aspect is to determine when to send which data, to keep the cloud updated without incurring unnecessary expense for sending unnecessary data. To do this, the following principles are currently used:</p>
<ul>
<li>The current or last values for all profiled channels of each devices are published once at the time of connection to Azure, using the "Realtimes" message.</li>
<li>At connection time, the iot_agent also checks each device to see if the CDS has trend data from the last interval available for it, and publishes that too if it is available.</li>
<li>At (almost) every run of the <a class="el" href="../../dd/d68/classCIotDeviceClient.html" title="Actor that creates a Client IoT Device client and manages its connection to the Azure IoT Hub...">CIotDeviceClient</a> timer task, it checks to see if there are any changes (updates) in the channel values for each device, and publishes these changed values in the Realtimes message.</li>
<li>The first time the timer task runs after the trend interval is closed,<ul>
<li>It publishes all of the channel values as Realtimes (per an agreement with PX White), even if they haven't been updated.</li>
<li>If the "Realtimes as Trends" is enabled by the build, it sends these message(s).</li>
<li>If the "Routed Channel List" is enabled, it sends these message(s).</li>
</ul>
</li>
<li>The <a class="el" href="../../dd/d68/classCIotDeviceClient.html" title="Actor that creates a Client IoT Device client and manages its connection to the Azure IoT Hub...">CIotDeviceClient</a> timer task also checks to see if it is time to publish Trends data from the CDS (ie, once every 5 minutes), and, if so, publishes the last trend interval's data for each device.<ul>
<li>The timing of this is not simply right after the end of the 5 minute interval, as you might expect; instead, the timer task waits until at least 2 minutes after the interval ended, to make sure that the CDS has had enough time to close the interval and make all of its data available.</li>
<li>It also publishes the DeviceRealTimes (ie, state) message just for the Publisher device at this time, as a heartbeat. In this way, even if the devices have no data to send, the iot_agent does send at least one message every trend interval.</li>
</ul>
</li>
</ul>
<p>The <a class="el" href="../../dd/d68/classCIotDeviceClient.html" title="Actor that creates a Client IoT Device client and manages its connection to the Azure IoT Hub...">CIotDeviceClient</a> timer task is paced by an ASIO Timer, which invokes the <a class="el" href="../../dd/d68/classCIotDeviceClient.html#ac3e59938659409ee0adee10292047aca" title="Called by the core&#39;s update timer to manage next state / action. ">CIotDeviceClient::handle_timer_update()</a> to execute this task. The default update interval of _UPDATE_TIMER_MSECS is set to 1 second, so this is the normal timebase on which this task is run. (It can be varied for unusual circumstances, such as reconnection delays.)</p>
<p>Note that the Realtimes and Trends publishing is on a per-device basis; that is, the data for each device is published in a messages separate from that of the other device data messages.</p>
<h3>Setting the Cadence for Realtimes to a non-default interval</h3>
<p>As described above, the normal cadence for publishing Realtimes data is 1s and for Trends it is 5 minutes; this provides the most responsive update rate. However, to economize data publishing, a product can be built to use a different cadence, by setting the CONFIG_IOT_REALTIME_CADENCE_SECS build variable.</p>
<p>If this is set to an interval of less than 5 minutes, then the Realtimes will be updated only at this interval, but Trends will remain at 5 minutes.</p>
<p>If this is set to an intervalgreater than, or equal to, 5 minutes (the only valid choices are 5 minutes, 15 minutes, 1 hour, and 24 hours), then both the Realtimes and Trends will only be updated at this interval.</p>
<h3>Trend Catch-up</h3>
<p>[This is a new feature under development.] </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri May 7 2021 20:26:03 for IoT Agent by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.5 </li>
  </ul>
</div>
</body>
</html>
